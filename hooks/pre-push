#!/bin/bash
# Pre-push hook: Lightweight validation before push
# Full CI runs on merge to main â€” this just catches obvious issues fast.

set -e

echo "Running pre-push checks..."

# String literal safety (no Flutter required)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

# Handle both hooks/ source dir and .git/hooks/ installed location
if [ -f "$PROJECT_ROOT/scripts/check-strings.sh" ]; then
    CHECK_STRINGS="$PROJECT_ROOT/scripts/check-strings.sh"
elif [ -f "$PROJECT_ROOT/../scripts/check-strings.sh" ]; then
    CHECK_STRINGS="$PROJECT_ROOT/../scripts/check-strings.sh"
else
    CHECK_STRINGS="$(git rev-parse --show-toplevel 2>/dev/null)/scripts/check-strings.sh"
fi

if [ -f "$CHECK_STRINGS" ]; then
    echo ""
    echo "Step 1: String literal safety..."
    bash "$CHECK_STRINGS"
fi

# Lightweight lint (no Flutter required)
if [ -f "$PROJECT_ROOT/scripts/lint-noflutter.sh" ]; then
    LINT_SCRIPT="$PROJECT_ROOT/scripts/lint-noflutter.sh"
elif [ -f "$PROJECT_ROOT/../scripts/lint-noflutter.sh" ]; then
    LINT_SCRIPT="$PROJECT_ROOT/../scripts/lint-noflutter.sh"
else
    LINT_SCRIPT="$(git rev-parse --show-toplevel 2>/dev/null)/scripts/lint-noflutter.sh"
fi

if [ -f "$LINT_SCRIPT" ]; then
    echo ""
    echo "Step 2: Lightweight lint..."
    bash "$LINT_SCRIPT"
fi

echo ""
echo "Pre-push checks passed. CI will run full validation on merge to main."
