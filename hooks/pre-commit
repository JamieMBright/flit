#!/bin/bash
# Pre-commit hook: Fast checks before commit
# Runs: string literal safety, format (auto-fix), analyze, unit tests
#
# Policy: formatting and linting are best-effort (auto-fix + warn).
# String literal safety and unit tests are blocking.

echo "Running pre-commit checks..."

# -----------------------------------------------------------------------
# Step 1: String literal safety (runs WITHOUT Flutter - pure bash/grep)
# Catches unterminated string literals, bad escapes, and other common
# Dart string issues in staged files.
# -----------------------------------------------------------------------
echo ""
echo "Step 1: Checking Dart string literal safety..."

STAGED_DART=$(git diff --cached --name-only --diff-filter=ACM -- '*.dart' || true)

if [ -n "$STAGED_DART" ]; then
    STRING_ERRORS=0

    for file in $STAGED_DART; do
        # Skip non-existent files (deleted)
        [ -f "$file" ] || continue

        # Check 1: \\' pattern (escaped backslash + bare quote).
        # The #1 codegen bug: Python writes \\' which Dart interprets as
        # escaped-backslash + string-terminator.
        MATCHES=$(grep -nP "(?<!r)(?<!r\")'\S*\\\\\\\\'" "$file" 2>/dev/null || true)
        if [ -n "$MATCHES" ]; then
            while IFS= read -r line; do
                LINETEXT=$(echo "$line" | cut -d: -f2-)
                # Skip raw strings and comments.
                if echo "$LINETEXT" | grep -qP '^\s*//' 2>/dev/null; then continue; fi
                if echo "$LINETEXT" | grep -qP "r['\"]" 2>/dev/null; then continue; fi
                echo "  ERROR in $file (line $(echo "$line" | cut -d: -f1)): broken escape (\\\\') found"
                STRING_ERRORS=$((STRING_ERRORS + 1))
            done <<< "$MATCHES"
        fi

        # Check 2: Unescaped apostrophe in single-quoted string.
        # Heuristic: 'text'text' pattern (apostrophe between word chars).
        MATCHES=$(grep -nP "'[^'\\\\]*[a-zA-Z]'[a-zA-Z]" "$file" 2>/dev/null || true)
        if [ -n "$MATCHES" ]; then
            while IFS= read -r line; do
                LINETEXT=$(echo "$line" | cut -d: -f2-)
                # Skip comments.
                if echo "$LINETEXT" | grep -qP '^\s*//' 2>/dev/null; then continue; fi
                # Skip apostrophes safely inside double-quoted strings.
                if echo "$LINETEXT" | grep -qP '"[^"]*'"'"'[^"]*"' 2>/dev/null; then continue; fi
                # Skip raw strings.
                if echo "$LINETEXT" | grep -qP "r'" 2>/dev/null; then continue; fi
                echo "  WARNING in $file (line $(echo "$line" | cut -d: -f1)): possible unescaped apostrophe"
                STRING_ERRORS=$((STRING_ERRORS + 1))
            done <<< "$MATCHES"
        fi
    done

    if [ "$STRING_ERRORS" -gt 0 ]; then
        echo ""
        echo "FAILED: Found $STRING_ERRORS string literal issue(s)."
        echo "Fix the issues above before committing."
        echo ""
        echo "Tips:"
        echo "  - Use double quotes for strings with apostrophes: \"St. John's\""
        echo "  - Or escape properly in single quotes: 'St. John\\'s'"
        echo "  - Use SafeString.toDartLiteral() in code-gen scripts"
        echo "  - See lib/core/utils/safe_string.dart for utilities"
        exit 1
    fi

    echo "  String literal checks passed."
else
    echo "  No staged Dart files to check."
fi

# -----------------------------------------------------------------------
# Step 2+: Flutter-dependent checks (or fallback to no-Flutter lint)
# -----------------------------------------------------------------------
if ! command -v flutter &> /dev/null; then
    echo ""
    echo "Flutter not found - running lightweight lint checks..."

    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
    # Handle both hooks/ source dir and .git/hooks/ installed location
    if [ -f "$PROJECT_ROOT/scripts/lint-noflutter.sh" ]; then
        LINT_SCRIPT="$PROJECT_ROOT/scripts/lint-noflutter.sh"
    elif [ -f "$PROJECT_ROOT/../scripts/lint-noflutter.sh" ]; then
        LINT_SCRIPT="$PROJECT_ROOT/../scripts/lint-noflutter.sh"
    else
        # Try relative to git root
        LINT_SCRIPT="$(git rev-parse --show-toplevel 2>/dev/null)/scripts/lint-noflutter.sh"
    fi

    if [ -f "$LINT_SCRIPT" ]; then
        bash "$LINT_SCRIPT" --staged
    else
        echo "WARNING: lint-noflutter.sh not found - skipping lint checks"
        echo "CI will run full validation on push"
    fi

    # -------------------------------------------------------------------
    # dart format check (no-Flutter path)
    # Tries to find a dart binary even when Flutter isn't installed.
    # -------------------------------------------------------------------
    DART_BIN=""
    if command -v dart &> /dev/null; then
        DART_BIN="dart"
    elif [ -x "/tmp/dart-sdk/bin/dart" ]; then
        DART_BIN="/tmp/dart-sdk/bin/dart"
    fi

    if [ -n "$DART_BIN" ]; then
        # -------------------------------------------------------------------
        # Step 2: Auto-fix formatting (best-effort, non-blocking)
        # Applies dart format to all staged Dart files, then re-stages them.
        # -------------------------------------------------------------------
        echo ""
        echo "Step 2: Auto-fixing formatting..."
        if $DART_BIN format lib/ test/ 2>/dev/null; then
            # Re-stage any files that were reformatted
            if [ -n "$STAGED_DART" ]; then
                for file in $STAGED_DART; do
                    [ -f "$file" ] && git add "$file"
                done
            fi
            echo "  Formatting applied and staged."
        else
            echo "  WARNING: dart format failed — skipping auto-fix."
        fi

        # Check if anything still doesn't match (informational only)
        if ! $DART_BIN format --set-exit-if-changed lib/ test/ > /dev/null 2>&1; then
            echo "  Note: some files may still have formatting differences."
        fi

        # -------------------------------------------------------------------
        # Step 3: dart analyze (best-effort, non-blocking)
        # Runs the analyzer and reports issues as warnings.
        # -------------------------------------------------------------------
        echo ""
        echo "Step 3: Running dart analyze..."
        if $DART_BIN analyze --fatal-infos lib/ test/ 2>/dev/null; then
            echo "  Analyzer check passed."
        else
            echo "  WARNING: dart analyze found issues (non-blocking). Review output above."
            echo "  CI will also report these. Fix when convenient."
        fi
    else
        echo ""
        echo "WARNING: dart not found - skipping dart format and analyze checks"
        echo "Install Dart SDK or run: curl -fsSL https://storage.googleapis.com/dart-archive/channels/stable/release/latest/sdk/dartsdk-linux-x64-release.zip -o /tmp/dart.zip && unzip -qo /tmp/dart.zip -d /tmp/"
    fi

    echo ""
    echo "Pre-commit checks passed (no-Flutter mode)."
    exit 0
fi

# -------------------------------------------------------------------
# Step 2: Auto-fix formatting (best-effort, non-blocking)
# -------------------------------------------------------------------
echo ""
echo "Step 2: Auto-fixing formatting..."
if dart format lib/ test/ 2>/dev/null; then
    # Re-stage any reformatted files
    STAGED_DART_ALL=$(git diff --cached --name-only --diff-filter=ACM -- '*.dart' || true)
    if [ -n "$STAGED_DART_ALL" ]; then
        for file in $STAGED_DART_ALL; do
            [ -f "$file" ] && git add "$file"
        done
    fi
    echo "  Formatting applied and staged."
else
    echo "  WARNING: dart format failed — skipping auto-fix."
fi

# -------------------------------------------------------------------
# Step 3: Analyze (best-effort, non-blocking)
# -------------------------------------------------------------------
echo ""
echo "Step 3: Running analyzer..."
if flutter analyze --fatal-infos; then
    echo "  Analyzer check passed."
else
    echo "  WARNING: analyzer found issues (non-blocking). Fix when convenient."
fi

# -------------------------------------------------------------------
# Step 4: Unit tests (BLOCKING — tests must pass)
# -------------------------------------------------------------------
echo ""
echo "Step 4: Running unit tests..."
flutter test --coverage

echo ""
echo "Pre-commit checks passed!"
