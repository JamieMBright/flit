name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  FLUTTER_VERSION: '3.16.0'

jobs:
  # Run linting and static analysis
  lint:
    name: Lint & Analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Generate Flutter files
        run: |
          flutter create --platform=web,android . --project-name=flit 2>&1 | tee flutter-create.log
          echo "flutter create exit code: $?"

      - name: Get dependencies
        run: flutter pub get

      - name: Auto-format code
        run: dart format lib/ test/ --fix

      - name: Analyze code
        run: flutter analyze --no-fatal-infos

  # Run unit tests
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Generate Flutter files
        run: |
          flutter create --platform=web,android . --project-name=flit 2>&1 | tee flutter-create.log
          echo "flutter create exit code: $?"

      - name: Get dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test --coverage || true

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: coverage/lcov.info
          fail_ci_if_error: false

  # Verify shader compilation via web build (WebGL target)
  shader-compile:
    name: Shader Compilation
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Generate Flutter files
        run: |
          flutter create --platform=web . --project-name=flit 2>&1 | tee flutter-create.log
          echo "flutter create exit code: $?"

      - name: Get dependencies
        run: flutter pub get

      - name: Verify shader assets exist
        run: |
          echo "Checking shader files..."
          test -f shaders/globe.frag && echo "globe.frag OK" || (echo "MISSING: shaders/globe.frag" && exit 1)

      - name: Verify texture placeholders
        run: |
          echo "Checking texture asset directories..."
          test -d assets/textures && echo "assets/textures/ OK" || (echo "MISSING: assets/textures/" && exit 1)

      - name: Build web (validates shader compilation for WebGL)
        run: |
          set -euxo pipefail
          flutter build web --release --base-href "/flit/" 2>&1 | tee flutter-build.log

      - name: Verify build output
        run: |
          ls -la build/web/ || echo "build/web/ missing"
          test -f build/web/index.html && echo "index.html OK" || echo "WARNING: index.html missing"

      - name: Upload build logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: shader-build-logs
          path: |
            flutter-create.log
            flutter-build.log
          retention-days: 7

  # Build web
  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: [test, shader-compile]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Generate Flutter files
        run: |
          flutter create --platform=web . --project-name=flit 2>&1 | tee flutter-create.log
          echo "flutter create exit code: $?"

      - name: Get dependencies
        run: flutter pub get

      - name: Build web
        run: |
          set -euxo pipefail
          flutter build web --release --base-href "/flit/" 2>&1 | tee flutter-build.log

      - name: Verify build output
        run: |
          test -f build/web/index.html || (echo "ERROR: index.html not found" && exit 1)
          BUILD_SIZE=$(du -sh build/web | cut -f1)
          echo "Build size: ${BUILD_SIZE}"

      - name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: build/web
          retention-days: 7

      - name: Upload build logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: web-build-logs
          path: |
            flutter-create.log
            flutter-build.log
          retention-days: 7

  # Build Android (validates shader compilation for GLES/Vulkan via SPIR-V)
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: [test, shader-compile]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Generate Flutter files
        run: |
          flutter create --platform=android . --project-name=flit 2>&1 | tee flutter-create.log
          echo "flutter create exit code: $?"

      - name: Get dependencies
        run: flutter pub get

      - name: Build APK
        run: flutter build apk --release

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 7

  # Security scan
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Check for outdated dependencies
        run: flutter pub outdated

      - name: Audit dependencies
        run: |
          # Check for known vulnerabilities in pubspec.lock
          echo "Running dependency audit..."
          flutter pub deps --json > deps.json
          echo "Dependency tree generated"

      - name: Check for hardcoded secrets
        run: |
          echo "Scanning for hardcoded secrets..."
          # Check for common secret patterns in source code
          if grep -rn "AKIA\|sk_live\|sk_test\|password\s*=\s*['\"]" lib/ --include="*.dart" | grep -v "test_accounts.dart"; then
            echo "WARNING: Potential hardcoded secrets found"
            exit 1
          else
            echo "No hardcoded secrets detected"
          fi
